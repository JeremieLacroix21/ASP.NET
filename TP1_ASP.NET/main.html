<!DOCTYPE html>
<!--Liste d'objects de classe Contact
- Mise en forme de l'interface en trois sections exploitant le style display:grid et grid-template-columns
- Le formulaire apparaît suite au clic sur + ou sur le bouton de modification d'un contact
- Le survol des boutons fait apparaître une infobulle
- Le retrait doit être confirmé via un dialogue
- La liste des contacts est déroulante
- Utilisation de la classe ValidationProvider pour le formulaire
- Une fonction de validation pour chacun des champs:
       - Nom : non vide, seulement des caractères alphabétiques
       - Téléphone : non vide, masque de saisie avec jQuery (bonus)
       - Email : non vide, syntaxe vérifiée par regex (bonus)
- Pour la surbrillance de la rangée de contact survolée :
       - Chacune des cellules devront être construites par programmation et posséder la classe CSS cell et row_x (x étant le numéro de la rangée)
       - Chacune des cellules devront réagir au mouseover et mouseleave afin de mettre à jour la couleur de fond
       - Les boutons de modification et retrait devront être construits par programmation et doivent apparaître lors d'un survol de leur rangée-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta author="Charles Bourgeois et Jérémie Lacroix">
    <meta http-equiv="Content-Type" content="text/html; charset= ISO-8859-1">
    <title>TP 1 Web</title>
    <!-- Fichier local qui contient la librairie jQuery -->
    <script src="js/jquery-3.3.1.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- Style pour les infobulles -->
    <link rel="stylesheet" href="css/tooltip.css">
    <!-- Style pour l'interface et la liste des contacts -->
    <link rel="stylesheet" href="css/stylesheet.css">
    <!-- Fichier local qui contient la librairie de Validation -->
    <script src="js/Validation.js"></script>
    <!-- Fichier local qui contient les fonctions de requÃªte au service Web API -->
    <script src="js/contactManagerWebAPIRequest.js"></script>
    <!-- pour la dialogue de confirmation de retrait d'un contact -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <script src="js/jquery.maskedinput.js"></script>
    <!-- lien vers le favicon gÃ©nÃ©rÃ© par https://favicon.io/favicon-converter/-->
    <link rel="icon" href="favicon.ico">
    <link rel="manifest" href="site.webmanifest">
</head>
<body>
    <!-- Liste de contact -->
    <div class="container">
        <h3 style="color :black"> <img src="favicon.jpeg"> &nbsp; Gestionaire des contacts</h3> 
        <div class="blackbordure">
            <div class="main-header">
                <div class="main-contact">
                    <div>Nom</div>
                    <div>Téléphone</div>
                    <div>Courriel</div>
                    <div>
                        <button id="barreAjout" tooltip="Ajouter un contact" tooltip-position="left">
                            <span class="glyphicon glyphicon-plus"></span> 
                        </button>
                    </div>
                    <div>&nbsp;</div>
                </div>
            </div>
            <div class="main-container">
                <div class="main-contact-container" id="contactContainer">
                    <div>
                        <input type="hidden" id="Id" />
                        <input type="text" id="Name" placeholder="Nom" class="form-control" />
                    </div>
                    <div>
                        <input type="text" id="Phone" placeholder="Téléphone" class="phone form-control" />
                    </div>
                    <div>
                        <input type="text" id="Email" placeholder="Courriel" class="form-control" />
                    </div>
                    <div>
                        <button id="ajoutContact" tooltip="Ajouter" tooltip-position="left">
                            <span class="glyphicon glyphicon glyphicon-ok"></span>
                        </button>
                        <button id="modifierContact" tooltip="Modifier" tooltip-position="left">
                            <span class="glyphicon glyphicon-pencil"></span>
                        </button>
                    </div>
                    <div>
                        <button id="cancel" tooltip="Annuler" tooltip-position="left">
                            <span class="glyphicon glyphicon-repeat"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="main-list">
                <div class="main-contact-list" id="list">
                <!-- faites par id-->
                </div>
            </div>
        </div>
    </div>
        <!-- Fonctions -->
        <script>
            "use strict";
            $(document).ready(initUI);

            let modifier = false;
            let ajouter = false;
            let validationProvider;

            function initUI() {
                initValidation();
                eraseControl();
                //clic boutons 
                $('#ajoutContact').click(ajoutContact);
                $('#barreAjout').click(barreAjout);
                $('#modifierContact').click(modifierContact);
                $('#cancel').click(eraseControl);
                $('#Name').keypress(textInputAlphaFilter);
                //message d'attente
                MessageDattente();
                getContacts();
            }

            function MessageDattente() {
                $('#list').empty()
                $('#list').append(makeCell("En attente de réponse du service Web...", "waiting"));
                $('#list').append($('<img src="images/Loading_icon.gif" alt="waiting"/>'));
            }
            function insertErrorStatus(status){
                $('#list').empty()
                $('#list').append($('<img src="images/error.png" style="width:60px;margin:10px" alt="httpError"/>'));
                $('#list').append(  makeCell("Erreur de requÃªte au service Web...", "httpError"));
                $('#list').append(  makeCell(status, "httpError"));
            }
            //validation provider 
            function initValidation() {
                $(".phone").mask("(999) 999-9999");
                validationProvider = new ValidationProvider();
                validationProvider.addControl("Name", validate_Name);
                validationProvider.addControl("Phone", validate_Phone);
                validationProvider.addControl("Email", validate_email);
            }
            function resetValidation() {
                validationProvider.reset();
            }
            function validate_Name() {
                let TBX_FirstName = document.getElementById("Name");

                if (TBX_FirstName.value === "")
                    return "Nom manquant";

                return "";
            }
            function validate_Phone() {
                let TBX_LastName = document.getElementById("Phone");

                if (TBX_LastName.value === "")
                    return "TÃ©lÃ©phone manquant";

                return "";
            }
            function validate_email() {
                let TBX_Email = document.getElementById("Email");
                let emailRegex = /^([\w\.\-]+)@([\w\-]+)((\.(\w){2,3})+)$/;

                if (TBX_Email.value === "")
                    return "Adresse de courriel manquante";

                if (!emailRegex.test(TBX_Email.value))
                    return "Adresse de courriel invalide";

                return "";
            }
            //fin du validation provider
            //début du erasecontrol
            function eraseControl() {
                ajouter = false;
                modifier = false;
                resetValidation();

                // rÃ©tablir la couleur de fond de toutes les rangÃ©es
                $('.cell').removeClass('selectedRow');

                // masquer le formulaire de saisie/modification de contact
                $('#contactContainer').hide();

                // RÃ©tablir la visibilitÃ© par dÃ©faut des boutons
                $('#ajoutContact').show();
                $('#modifierContact').hide();
                $('#barreAjout').show();

                // Effacer les champs du formulaire
                $('#Name').val('');
                $('#Phone').val('');
                $('#Email').val('');

                // Masquer tous les boutons des rangÃ©es de contact
                $('#list button').hide();
            }
            //fin du erasecontrol
            // Requète au service web API: Liste des contacts
            function getContacts() {
                webAPI_getContacts(updateContactList, insertErrorStatus);
            }
            // Afficher le formulaire pour la saisie de contact
            function showAddContact() {
                addMode = true;
                $('#contactContainer').show();
                $('#barreAjout').hide();
            }
            // Afficher le formulaire pour la modification de contact
            function showEditContact(e) {
                editMode = true;
                $('#barreAjout').hide();
                $('#ajoutContact').hide();
                $('#contactContainer').show();

                let contactId = e.currentTarget.id.split('_')[1];
                webAPI_getContact(contactId, ShowForm);
            }

            function ShowForm(contact) {
                // peupler les contrÃ´les de saisie
                $('#Id').val(contact.Id); 
                $('#Name').val(contact.Name);
                $('#Phone').val(contact.Phone);
                $('#Email').val(contact.Email);
                $('#modifierContact').show();
            }

            // Retourne un objet contact Ã  partir des valeurs prÃ©levÃ©es se trouvant dans les contrÃ´les de saisie.
            // Si le paramÃ¨tre includeId est vrai, inclure le Id du contact dans l'objet contact retournÃ©
            function makeContactFromForm(includeId = false) {
                if (includeId) {
                    // RÃ©cupÃ©ration du Id du contact dans le contrÃ´le cachÃ©
                    let contactId = $('#Id').val();
                    return {Id: contactId, Name: $('#Name').val(), Phone: $('#Phone').val(), Email: $('#Email').val()};
                }
                return { Name: $('#Name').val(), Phone: $('#Phone').val(), Email: $('#Email').val()};
            }


                // Ajout d'un contact
                function addContact() {
                    let contact = makeContactFromForm();
                    if (validationProvider.isValid()) {
                        webAPI_addContact(contact, getContacts, insertErrorStatus);
                    }
                }

                // RequÃªte au service Web API: Modification d'un contact
                function modifyContact() {
                    // construction de l'objet contact
                    let contact = makeContactFromForm(true);
                    if (validationProvider.isValid()) {
                        webAPI_modifyContact(contact, getContacts, insertErrorStatus);
                    }
                }
            // AprÃ¨s confirmation, requÃªte au service Web API de retrait d'un contact
            function deleteContact(e) {
                // Extraction du Id du contact inscrit dans l'attribut id de l'Ã©lÃ©ment dÃ©clencheur de l'Ã©vÃ©nement click
                let contactId = e.currentTarget.id.split('_')[1];
                webAPI_getContact(contactId, confirmDeleteContact, insertErrorStatus);
            }

            function confirmDeleteContact(contact) {
                $.confirm({
                    title: 'Attention!',
                    content: 'Effacer '+ contact.Name +'?',
                    buttons: {
                        confirmer: function () {
                            webAPI_deleteContact(contact.Id, getContacts, insertErrorStatus);
                        },
                        annuler: {},
                    }
                });
            }

            function cellOver(e){
                if (!ajouter && !modifier) {
                    // currentTarget.className contient en principe : 'row_x cell ...'
                    let contactId = e.currentTarget.className.split(' ')[0].split('_')[1];
                    $('#edit_' + contactId).show();
                    $('#delete_' + contactId).show();
                    $('.row_'+contactId).addClass('selectedRow');
                }
            }
            function cellBlur(e){
                if (!modifier) {
                    // currentTarget.className contient en principe : 'row_x cell ...'
                    let contactId = e.currentTarget.className.split(' ')[0].split('_')[1];
                    $('#edit_' + contactId).hide();
                    $('#delete_' + contactId).hide();
                    $('.row_'+contactId).removeClass('selectedRow');
                }
            }

            function makeCell(content, cssClass){
                return $('<div class= "' + cssClass + '">' + content + '</div>');
            }

            function makeButton(cssClass, id, tooltip) {
                return $('<button id="' + id + '" class="'+ cssClass + '"tooltip="' + tooltip + '" tooltip-position="left"></button>');
            }

            function makeGlyphIcon(glyphIconId){
                return $("<span class='glyphicon glyphicon-" + glyphIconId + "'></span>");
            }

            // Rafraichir la liste des contacts
            // paramÃ¨tre contacts: tableau d'objets contact
            function updateContactList(contacts) {
                eraseControl();
                var oddRow = true;
                // effacer le tableau affichant la liste de contacts
                $('#list').empty();

                // pour tous les contacts du tableau contacts
                contacts.forEach(contact => { // crÃ©er une nouvelle rangÃ©e

                    // dÃ©terminer la couleur de la rangÃ©e
                    let bgColorRow = "row_" + contact.Id + " cell " + (oddRow?  "oddRow": "evenRow") ;

                    // Distribution des donnÃ©es du contact dans des cellules de la rangÃ©e
                    $('#list').append(makeCell(contact.Name, bgColorRow ));
                    $('#list').append(makeCell(contact.Phone, bgColorRow));
                    $('#list').append(makeCell(contact.Email, bgColorRow));

                    // Bouton d'appel Ã  la modification du contact
                    $('#list').append(
                        makeCell("", bgColorRow).append(
                            makeButton("editContact","edit_" + contact.Id ,"Modifier "+ contact.Name).append(
                                makeGlyphIcon('pencil'))));

                    // Bouton d'appel au retrait du contact
                    $('#list').append(
                        makeCell("", bgColorRow).append(
                            makeButton("deleteContact","delete_" + contact.Id ,"Effacer "+ contact.Name).append(
                                makeGlyphIcon('remove'))));

                    oddRow = !oddRow;
                });

                // Attacher les gestionnaires du clic aux nouveaux boutons
                $('.editContact').click(showEditContact);
                $('.deleteContact').click(deleteContact);
                $('#list button').hide();
                $('input').on("paste",function(e) { e.preventDefault(); });

                // Attacher les Ã©vÃ©nements pour mettre en surbrillance une rangÃ©e survolÃ©e
                $('.cell').mouseover(cellOver);
                $('.cell').mouseleave(cellBlur);
            }
        </script>
</body>

</html>